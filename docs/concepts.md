# Romanesco 言語設計思想：疎結合な SMT 統合と汎用プロパティ

## 1. 環境主導の SMT 翻訳 (Property-based Translation)

Romanesco では、AST ノードを SMT（Z3）の式へ変換する際、言語コアに演算子をハードコードせず、シンボルテーブルのプロパティを利用する疎結合な設計を採用している。

### smt-op プロパティ
- 各シンボルには、`"smt-op" -> "add"` や `"smt-op" -> "eq"` といったメタデータが付与される。
- `RomanescoSolver` は、ノードの関数名に対応するプロパティを環境から取得し、動的に Z3 の `mkAdd` や `mkEq` へマッピングする。
- これにより、ユーザーがマクロで定義した新しい演算子に対しても、プロパティを付与するだけで SMT ソルバーによる解決能力を後付けすることが可能である。

## 2. 絶縁された論理コンテキスト

リソース管理と独立性を担保するため、Z3 コンテキストは `SymbolTable` インスタンスごとにカプセル化されている。

- **独立した変数管理**: 論理変数（`? x`）の実体は各 `SymbolTable` の `logicalVars` マップで管理され、異なる実行コンテキスト間での干渉を防いでいる。
- **リソースの明示的解放**: `SymbolTable.close()` を通じて、ネイティブな Z3 コンテキストを安全に破棄できる仕組みを整え、メモリリークのリスクを排除した。

## 3. 同図像的な制約解決

- **`?` (Logical Variable)**: 自身を論理変数としてマークするための 1 引数関数。
- **`solve` (Constraint Solver)**: AST を入力として受け取り、環境のプロパティに従って論理式を構築・解決する。
- 全ての制約記述は Romanesco の標準的な `Apply` と `Atom` の構造であり、マクロ（編集者）によって自由に生成・加工が可能である。

## 4. 実行と制約の統合

中立的な記号セット（`&`, `|`, `!`, `=`, `>`, `<`）を導入し、同一の記述が文脈に応じて「真偽値の計算（実行）」と「論理式の構築（制約）」の両方の役割を果たす。この「解釈の多重性」こそが、Romanesco における型と制約の同一視を支える技術的基盤である。
